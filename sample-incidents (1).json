{
  "scenarios": [
    {
      "id": "payment-cascade",
      "name": "Payment Processing Timeout Cascade",
      "description": "A slow third-party payment processor triggers a retry storm that cascades through auth and API gateway services.",
      "category": "cascade",
      "expectedRootCause": "Third-party payment processor latency spike (avg 200ms â†’ 12s) causing connection pool exhaustion in payment-service, triggering retry storms that overload auth-service.",
      "serviceGraph": {
        "nodes": [
          { "id": "api-gateway", "name": "API Gateway", "type": "gateway", "status": "degraded", "errorCount": 847 },
          { "id": "payment-service", "name": "Payment Service", "type": "api", "status": "down", "errorCount": 2341 },
          { "id": "auth-service", "name": "Auth Service", "type": "api", "status": "degraded", "errorCount": 1205 },
          { "id": "user-service", "name": "User Service", "type": "api", "status": "healthy", "errorCount": 3 },
          { "id": "payment-processor", "name": "Stripe API", "type": "external", "status": "degraded", "errorCount": 0 },
          { "id": "payments-db", "name": "Payments DB", "type": "database", "status": "healthy", "errorCount": 0 },
          { "id": "redis-cache", "name": "Redis Cache", "type": "cache", "status": "healthy", "errorCount": 0 }
        ],
        "edges": [
          { "source": "api-gateway", "target": "payment-service", "protocol": "http", "label": "POST /payments" },
          { "source": "api-gateway", "target": "auth-service", "protocol": "http", "label": "Token validation" },
          { "source": "api-gateway", "target": "user-service", "protocol": "http", "label": "GET /users" },
          { "source": "payment-service", "target": "payment-processor", "protocol": "http", "label": "Charge API" },
          { "source": "payment-service", "target": "payments-db", "protocol": "sql" },
          { "source": "payment-service", "target": "auth-service", "protocol": "grpc", "label": "validateToken" },
          { "source": "auth-service", "target": "redis-cache", "protocol": "redis", "label": "Session lookup" }
        ]
      },
      "logs": "2025-01-15T14:23:01.003Z INFO  [payment-service] Processing payment request pay_8x7k2m amount=49.99 currency=USD user=usr_441\n2025-01-15T14:23:01.205Z INFO  [payment-service] Calling Stripe API for charge ch_3x9f timeout=5000ms\n2025-01-15T14:23:06.210Z WARN  [payment-service] Stripe API response slow latency=5005ms charge=ch_3x9f - approaching timeout\n2025-01-15T14:23:06.211Z INFO  [payment-service] Retrying Stripe API call attempt=2/3 charge=ch_3x9f\n2025-01-15T14:23:11.218Z ERROR [payment-service] Stripe API timeout after 5007ms attempt=2 charge=ch_3x9f\n2025-01-15T14:23:11.219Z INFO  [payment-service] Retrying Stripe API call attempt=3/3 charge=ch_3x9f\n2025-01-15T14:23:16.225Z ERROR [payment-service] Stripe API timeout after 5006ms attempt=3 FINAL charge=ch_3x9f\n2025-01-15T14:23:16.226Z ERROR [payment-service] Payment failed after 3 retries pay_8x7k2m elapsed=15222ms\n2025-01-15T14:23:16.300Z WARN  [payment-service] Connection pool utilization at 87% (43/50 connections)\n2025-01-15T14:23:17.100Z INFO  [payment-service] Processing payment request pay_9r3j1n amount=129.00 currency=USD user=usr_882\n2025-01-15T14:23:17.102Z INFO  [payment-service] Processing payment request pay_2k8m4p amount=19.99 currency=USD user=usr_117\n2025-01-15T14:23:17.200Z INFO  [payment-service] Calling Stripe API for charge ch_7y2k timeout=5000ms\n2025-01-15T14:23:17.201Z INFO  [payment-service] Calling Stripe API for charge ch_1p5r timeout=5000ms\n2025-01-15T14:23:22.205Z ERROR [payment-service] Stripe API timeout after 5005ms attempt=1 charge=ch_7y2k\n2025-01-15T14:23:22.206Z ERROR [payment-service] Stripe API timeout after 5005ms attempt=1 charge=ch_1p5r\n2025-01-15T14:23:22.300Z ERROR [payment-service] Connection pool utilization at 96% (48/50 connections)\n2025-01-15T14:23:22.301Z WARN  [payment-service] Circuit breaker OPEN for stripe-api - failure rate 94% (threshold: 50%)\n2025-01-15T14:23:22.500Z ERROR [api-gateway] Upstream timeout from payment-service for POST /api/v1/payments - 503 Service Unavailable\n2025-01-15T14:23:22.600Z WARN  [auth-service] Elevated request rate detected - 340 req/s (normal: 120 req/s)\n2025-01-15T14:23:22.700Z WARN  [auth-service] Token validation latency increased p99=450ms (normal: 12ms)\n2025-01-15T14:23:23.100Z ERROR [api-gateway] Upstream timeout from payment-service for POST /api/v1/payments - 503 Service Unavailable\n2025-01-15T14:23:23.200Z ERROR [api-gateway] Upstream timeout from auth-service for token validation - 504 Gateway Timeout\n2025-01-15T14:23:23.300Z ERROR [auth-service] Redis connection pool exhausted - cannot validate tokens\n2025-01-15T14:23:23.400Z FATAL [api-gateway] Multiple upstream failures - entering degraded mode. Healthy upstreams: [user-service]\n2025-01-15T14:23:23.401Z ERROR [api-gateway] Returning 503 for all payment and auth-dependent routes\n2025-01-15T14:23:24.000Z INFO  [payment-service] Circuit breaker preventing calls to stripe-api - fast-failing requests\n2025-01-15T14:23:25.000Z WARN  [api-gateway] Error rate: 73% of requests returning 5xx (last 60s)\n2025-01-15T14:23:30.000Z INFO  [payment-service] Circuit breaker half-open - testing stripe-api with single request\n2025-01-15T14:23:32.100Z INFO  [payment-service] Stripe API responded latency=2100ms - elevated but functional\n2025-01-15T14:23:32.200Z INFO  [payment-service] Circuit breaker CLOSED - resuming normal traffic to stripe-api\n2025-01-15T14:23:33.000Z INFO  [auth-service] Request rate normalizing - 145 req/s\n2025-01-15T14:23:35.000Z INFO  [api-gateway] Error rate decreasing: 12% of requests returning 5xx (last 60s)\n2025-01-15T14:23:40.000Z INFO  [api-gateway] System recovering - all upstreams healthy"
    },
    {
      "id": "config-deploy",
      "name": "Feature Flag Deployment Gone Wrong",
      "description": "A feature flag change enables a new code path with a null reference bug, causing 30% of requests to fail until rollback.",
      "category": "config",
      "expectedRootCause": "Feature flag 'enable-new-pricing-engine' activated at 10:15:00Z introduced a null reference in PricingEngine.calculateDiscount() when user has no subscription history.",
      "serviceGraph": {
        "nodes": [
          { "id": "api-gateway", "name": "API Gateway", "type": "gateway", "status": "degraded", "errorCount": 412 },
          { "id": "pricing-service", "name": "Pricing Service", "type": "api", "status": "degraded", "errorCount": 1893 },
          { "id": "config-service", "name": "Config Service", "type": "api", "status": "healthy", "errorCount": 0 },
          { "id": "catalog-service", "name": "Catalog Service", "type": "api", "status": "healthy", "errorCount": 0 },
          { "id": "pricing-db", "name": "Pricing DB", "type": "database", "status": "healthy", "errorCount": 0 },
          { "id": "feature-flags", "name": "LaunchDarkly", "type": "external", "status": "healthy", "errorCount": 0 }
        ],
        "edges": [
          { "source": "api-gateway", "target": "pricing-service", "protocol": "http", "label": "GET /pricing" },
          { "source": "api-gateway", "target": "catalog-service", "protocol": "http", "label": "GET /catalog" },
          { "source": "pricing-service", "target": "pricing-db", "protocol": "sql" },
          { "source": "pricing-service", "target": "config-service", "protocol": "grpc", "label": "getConfig" },
          { "source": "config-service", "target": "feature-flags", "protocol": "http", "label": "Flag evaluation" }
        ]
      },
      "logs": "2025-01-20T10:14:55.000Z INFO  [config-service] Feature flag update received: enable-new-pricing-engine = true (was: false)\n2025-01-20T10:14:55.001Z INFO  [config-service] Flag change deployed by user=eng_sarah scope=production rollout=100%\n2025-01-20T10:14:55.100Z INFO  [pricing-service] Config refresh: enable-new-pricing-engine now ENABLED\n2025-01-20T10:14:55.101Z INFO  [pricing-service] Switching to NewPricingEngine for discount calculations\n2025-01-20T10:15:00.200Z INFO  [pricing-service] Processing pricing request price_req_001 user=usr_220 plan=premium\n2025-01-20T10:15:00.250Z INFO  [pricing-service] NewPricingEngine.calculateDiscount() user=usr_220 subscriptionHistory=3 items\n2025-01-20T10:15:00.300Z INFO  [pricing-service] Pricing response price_req_001 basePrice=15.99 discount=20% finalPrice=12.79\n2025-01-20T10:15:01.100Z INFO  [pricing-service] Processing pricing request price_req_002 user=usr_887 plan=basic\n2025-01-20T10:15:01.150Z ERROR [pricing-service] NullReferenceException in NewPricingEngine.calculateDiscount() at line 142: Cannot read property 'length' of undefined - user=usr_887 subscriptionHistory=null\n2025-01-20T10:15:01.151Z ERROR [pricing-service] Stack trace: NewPricingEngine.calculateDiscount (pricing-engine.ts:142) > PricingController.getPrice (controller.ts:58) > Router.handle (router.ts:23)\n2025-01-20T10:15:01.200Z ERROR [api-gateway] 500 Internal Server Error from pricing-service for GET /api/v1/pricing?user=usr_887\n2025-01-20T10:15:02.000Z INFO  [pricing-service] Processing pricing request price_req_003 user=usr_103 plan=premium\n2025-01-20T10:15:02.050Z INFO  [pricing-service] NewPricingEngine.calculateDiscount() user=usr_103 subscriptionHistory=7 items\n2025-01-20T10:15:02.100Z INFO  [pricing-service] Pricing response price_req_003 OK\n2025-01-20T10:15:02.500Z ERROR [pricing-service] NullReferenceException in NewPricingEngine.calculateDiscount() at line 142 - user=usr_445 subscriptionHistory=null\n2025-01-20T10:15:03.100Z ERROR [pricing-service] NullReferenceException in NewPricingEngine.calculateDiscount() at line 142 - user=usr_612 subscriptionHistory=null\n2025-01-20T10:15:03.500Z ERROR [pricing-service] NullReferenceException in NewPricingEngine.calculateDiscount() at line 142 - user=usr_901 subscriptionHistory=null\n2025-01-20T10:15:04.000Z WARN  [pricing-service] Error rate spike detected: 31% of requests failing (threshold: 5%)\n2025-01-20T10:15:04.001Z WARN  [pricing-service] All failures in NewPricingEngine.calculateDiscount - NullReferenceException\n2025-01-20T10:15:04.100Z ERROR [api-gateway] Elevated 5xx rate from pricing-service: 31% (last 30s)\n2025-01-20T10:15:05.000Z WARN  [pricing-service] Pattern detected: failures correlate with users where subscriptionHistory is null (new users / no prior subscription)\n2025-01-20T10:15:10.000Z INFO  [config-service] Feature flag update received: enable-new-pricing-engine = false (rollback by user=eng_sarah)\n2025-01-20T10:15:10.100Z INFO  [pricing-service] Config refresh: enable-new-pricing-engine now DISABLED\n2025-01-20T10:15:10.101Z INFO  [pricing-service] Switching back to LegacyPricingEngine for discount calculations\n2025-01-20T10:15:11.000Z INFO  [pricing-service] Error rate normalizing: 0% failures (last 10s)\n2025-01-20T10:15:15.000Z INFO  [api-gateway] All upstreams healthy - error rate 0%"
    },
    {
      "id": "db-pool-exhaustion",
      "name": "Database Connection Pool Exhaustion",
      "description": "A slow analytical query blocks the connection pool, causing timeouts across all services that depend on the shared database.",
      "category": "resource",
      "expectedRootCause": "Unoptimized analytical query (missing index on user_events.created_at) holding connections for 45+ seconds, exhausting the shared connection pool for recommendation-service and content-service.",
      "serviceGraph": {
        "nodes": [
          { "id": "api-gateway", "name": "API Gateway", "type": "gateway", "status": "degraded", "errorCount": 234 },
          { "id": "recommendation-svc", "name": "Recommendation Service", "type": "api", "status": "down", "errorCount": 1567 },
          { "id": "content-service", "name": "Content Service", "type": "api", "status": "degraded", "errorCount": 445 },
          { "id": "analytics-worker", "name": "Analytics Worker", "type": "worker", "status": "degraded", "errorCount": 12 },
          { "id": "main-db", "name": "PostgreSQL Primary", "type": "database", "status": "degraded", "errorCount": 0 },
          { "id": "content-cache", "name": "Content Cache", "type": "cache", "status": "healthy", "errorCount": 0 },
          { "id": "event-queue", "name": "Kafka", "type": "queue", "status": "healthy", "errorCount": 0 }
        ],
        "edges": [
          { "source": "api-gateway", "target": "recommendation-svc", "protocol": "http", "label": "GET /recommendations" },
          { "source": "api-gateway", "target": "content-service", "protocol": "http", "label": "GET /content" },
          { "source": "recommendation-svc", "target": "main-db", "protocol": "sql", "label": "Shared pool" },
          { "source": "content-service", "target": "main-db", "protocol": "sql", "label": "Shared pool" },
          { "source": "content-service", "target": "content-cache", "protocol": "redis" },
          { "source": "analytics-worker", "target": "main-db", "protocol": "sql", "label": "Shared pool" },
          { "source": "analytics-worker", "target": "event-queue", "protocol": "kafka" }
        ]
      },
      "logs": "2025-01-22T09:00:00.000Z INFO  [analytics-worker] Starting daily user engagement report job_id=daily_report_0122\n2025-01-22T09:00:00.100Z INFO  [analytics-worker] Executing query: SELECT user_id, COUNT(*) as events, AVG(duration) FROM user_events WHERE created_at > '2025-01-01' GROUP BY user_id ORDER BY events DESC\n2025-01-22T09:00:00.200Z INFO  [main-db] Query started pid=4521 duration_estimate=unknown query=SELECT user_id, COUNT(*)... FROM user_events WHERE created_at > '2025-01-01'...\n2025-01-22T09:00:00.201Z WARN  [main-db] Sequential scan on user_events (42M rows) - no index on created_at column\n2025-01-22T09:00:05.000Z INFO  [main-db] Connection pool status: 18/20 active connections (analytics query holding 3)\n2025-01-22T09:00:10.000Z INFO  [recommendation-svc] Processing recommendation request for user=usr_331\n2025-01-22T09:00:10.100Z INFO  [recommendation-svc] Querying user preferences from main-db\n2025-01-22T09:00:10.200Z WARN  [main-db] Connection pool status: 20/20 active connections - pool exhausted\n2025-01-22T09:00:10.300Z WARN  [recommendation-svc] Database connection acquisition timeout after 5000ms\n2025-01-22T09:00:10.301Z ERROR [recommendation-svc] Failed to fetch user preferences - connection pool exhausted user=usr_331\n2025-01-22T09:00:11.000Z INFO  [content-service] Content request content_id=mov_8827\n2025-01-22T09:00:11.100Z INFO  [content-service] Cache MISS for content_id=mov_8827 - querying main-db\n2025-01-22T09:00:11.200Z WARN  [content-service] Database connection acquisition timeout after 5000ms content_id=mov_8827\n2025-01-22T09:00:11.201Z WARN  [content-service] Falling back to stale cache for content_id=mov_8827\n2025-01-22T09:00:15.000Z ERROR [recommendation-svc] 23 consecutive database connection failures in last 5 seconds\n2025-01-22T09:00:15.001Z ERROR [api-gateway] recommendation-svc returning 503 for 100% of requests\n2025-01-22T09:00:15.100Z WARN  [content-service] Stale cache serving 67% of requests - database connections unavailable\n2025-01-22T09:00:20.000Z WARN  [main-db] Long-running query pid=4521 elapsed=20s - still executing sequential scan on user_events\n2025-01-22T09:00:20.001Z WARN  [main-db] Active connections: analytics-worker=3, recommendation-svc=12(waiting), content-service=5(waiting)\n2025-01-22T09:00:30.000Z WARN  [main-db] Long-running query pid=4521 elapsed=30s - rows scanned: 28M/42M\n2025-01-22T09:00:30.001Z ERROR [recommendation-svc] Service health check FAILING - 0% database availability\n2025-01-22T09:00:45.000Z INFO  [main-db] Query completed pid=4521 elapsed=45.2s rows_returned=1.2M\n2025-01-22T09:00:45.100Z INFO  [analytics-worker] Daily report query completed elapsed=45.2s job_id=daily_report_0122\n2025-01-22T09:00:45.200Z INFO  [main-db] Releasing 3 connections from analytics-worker\n2025-01-22T09:00:45.300Z INFO  [main-db] Connection pool status: 17/20 active connections - pool recovering\n2025-01-22T09:00:46.000Z INFO  [recommendation-svc] Database connection acquired - resuming normal operations\n2025-01-22T09:00:46.100Z INFO  [content-service] Database connections restored - switching from stale cache to live queries\n2025-01-22T09:00:50.000Z INFO  [api-gateway] All upstreams recovering - error rate decreasing\n2025-01-22T09:00:55.000Z INFO  [recommendation-svc] Service health check PASSING - database connections stable"